unit UnitProduto;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, FMX.Objects,
  FMX.Controls.Presentation, FMX.StdCtrls, FMX.Layouts,
  System.Net.HttpClientComponent, System.Net.HttpClient, uLoading;

type
  TFrmProduto = class(TForm)
    lytToolBar: TLayout;
    lblTitulo: TLabel;
    imgVoltar: TImage;
    lytFoto: TLayout;
    imgFoto: TImage;
    lblDescricao: TLabel;
    lblInformacao: TLabel;
    lblPreco: TLabel;
    lytPreco: TLayout;
    lblValor: TLabel;
    lytPrecoUnd: TLayout;
    lblPrecoUnd: TLabel;
    lblValorUnd: TLabel;
    rctBottom: TRectangle;
    lytAdicionar: TLayout;
    imgMenos: TImage;
    imgMais: TImage;
    lblQtd: TLabel;
    btnAdicionar: TButton;
    lytFundo: TLayout;
    procedure FormResize(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    FId_produto: Integer;
    procedure LoadImageFromURL(img: TBitmap; url: string);
    procedure CarregarDados;
    procedure ThreadDadosTerminate(Sender: TObject);
    { Private declarations }
  public
    { Public declarations }
  property Id_produto : Integer read FId_produto write FId_produto;
  end;

var
  FrmProduto: TFrmProduto;

implementation

{$R *.fmx}

uses UnitPrincipal;

procedure TFrmProduto.CarregarDados;
begin
  var
  t : TThread;
  begin
    TLoading.Show(FrmProduto, '');
    t := TThread.CreateAnonymousThread(procedure
    var
    i : integer;
    begin
//    Sleep(3000); //teste do loading

    //buscando os dados do produto
    DmMercado.ListarProdutoId(Id_produto);

      with DmMercado.TabMercado do
      begin
      //thread paralela
      TThread.Synchronize(TThread.CurrentThread, procedure
        begin
           lblTitulo.Text := FieldByName('nome').AsString;
           lblEndereco.Text := fieldbyname('endereco').asstring;
           lblEntrega.Text := 'Entrega:' + FormatFloat(' R$#,##0.00', fieldbyname('vl_entrega').asfloat);
           lblPedMin.Text := 'Compra Mín:' + FormatFloat(' R$#,##0.00', fieldbyname('vl_compra_min').asfloat);
        end);

      end;

      // listar as categorias
      ListarCategorias;

  end);

  t.OnTerminate := ThreadDadosTerminate; //rotina de erro
  t.Start;
  end;
end;

//thread terminate dados
procedure TFrmProduto.ThreadDadosTerminate(Sender: TObject);
begin
  TLoading.Hide; //parar de exibir a bolinha executando

  if Sender is TThread then
  begin
    if Assigned(TThread(Sender).FatalException) then
    begin
        ShowMessage(Exception(TThread(sender).FatalException).Message);
        Exit;
    end;
  end;

   //carregar foto do produto

end;

procedure TFrmProduto.FormShow(Sender: TObject);
begin
   CarregarDados;
end;

//dowloand pela URL
procedure TFrmProduto.LoadImageFromURL (img: TBitmap; url : string);
var
  http: TNetHttpClient;
  vStream : TMemoryStream;
begin
  try
    try
      http := TNetHTTPClient.Create(nil);
      vStream := TMemoryStream.Create;

      if (Pos('https', LowerCase(url)) > 0) then
        HTTP.SecureProtocols := [THTTPSecureProtocol.TLS1,
                                 THTTPSecureProtocol.TLS11,
                                 THTTPSecureProtocol.TLS12];
     http.Get(url, vStream);
     vStream.Position :=0;

     img.LoadFromStream(vStream);

    except
    end;

  finally
    vStream.DisposeOf;
    http.DisposeOf;
  end;
end;

procedure TFrmProduto.FormResize(Sender: TObject);
begin
  if (FrmProduto.Width > 600) and (FrmProduto.Height > 600) then
  begin
      lytFundo.Align := TAlignLayout.Center;
      lytFundo.Height := 350;
  end
  else
      lytFundo.Align := TAlignLayout.Client;
end;


end.
